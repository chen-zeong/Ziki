# ARM Mac 显卡加速画质调节机制

## 概述

本文档详细说明了在 ARM 版本的 Mac 系统（Apple Silicon）上开启显卡加速后，视频压缩应用如何调节画质的完整机制。ARM Mac 使用 Apple 的 VideoToolbox 框架进行硬件加速编码，与传统的软件编码和其他平台的硬件加速有显著差异。

## 硬件编码器选择

### VideoToolbox 编码器映射

在 ARM Mac 上，根据选择的编解码器，系统会自动选择对应的 VideoToolbox 硬件编码器：

```rust
// 来源：src-tauri/src/video/compression.rs
if cfg!(target_os = "macos") && cfg!(target_arch = "aarch64") {
    match settings.codec {
        "H.264" => "h264_videotoolbox",
        "H.265" => "hevc_videotoolbox", 
        "ProRes" => "prores_videotoolbox",
        _ => map_codec_to_ffmpeg(&settings.codec)
    }
}
```

### 支持的编码器

- **h264_videotoolbox**: H.264 硬件编码
- **hevc_videotoolbox**: H.265/HEVC 硬件编码
- **prores_videotoolbox**: ProRes 硬件编码

## 画质控制机制

### 1. 质量参数类型

ARM Mac 的 VideoToolbox 使用与传统软件编码不同的质量控制方式：

#### 软件编码 vs VideoToolbox 对比

| 编解码器 | 软件编码 | VideoToolbox (ARM Mac) |
|---------|---------|------------------------|
| H.264   | CRF (0-51) | q:v (0-100) |
| H.265   | CRF (0-51) | q:v (0-100) |
| ProRes  | Profile | Profile |

#### 质量参数映射

```typescript
// 来源：src/config/qualityMappings.ts
'h264': {
  software: {
    paramType: 'crf',
    values: [32, 28, 23, 20, 18], // CRF值，越小质量越高
    defaultIndex: 2 // 默认CRF 23
  },
  hardware: {
    paramType: 'qv',
    values: [40, 55, 70, 75, 80], // q:v值，越大质量越高
    defaultIndex: 2 // 默认q:v 70
  }
}
```

### 2. 质量等级映射

前端UI提供5个质量等级，每个等级对应不同的参数值：

| 质量等级 | 软件编码(CRF) | VideoToolbox(q:v) | 描述 |
|---------|---------------|-------------------|------|
| 极低    | 32            | 40                | 最小文件大小 |
| 低      | 28            | 55                | 较小文件大小 |
| 中等    | 23            | 70                | 平衡质量与大小 |
| 高      | 20            | 75                | 高质量 |
| 极高    | 18            | 80                | 最高质量 |

### 3. 滑块连续调节

用户可以通过滑块在质量等级之间进行连续调节：

```typescript
// 来源：src/components/video-settings/QualitySettings.vue
const getEncoderQualityParam = (
  codec: string,
  isHardwareAccelerated: boolean,
  sliderValue: number // 0-100
) => {
  // 根据滑块值计算实际的质量参数
  // VideoToolbox: 数值越大质量越高
  // 软件编码CRF: 数值越小质量越高
}
```

## 位深度支持

### VideoToolbox 位深度处理

ARM Mac 的 VideoToolbox 对不同位深度有特殊处理：

```rust
// 像素格式选择
let pix_fmt = if is_videotoolbox {
    match settings.bit_depth {
        Some(12) => {
            println!("hevc_videotoolbox does not support 12-bit; falling back to 10-bit p010le");
            "p010le"
        },
        Some(10) => "p010le",
        _ => "nv12", // 默认8位
    }
} else {
    // 软件编码的像素格式
    match settings.bit_depth {
        Some(10) => "yuv420p10le",
        Some(12) => "yuv420p12le",
        _ => "yuv420p",
    }
};
```

### 配置文件设置

对于10位及以上的编码，VideoToolbox 需要特殊的配置文件：

```rust
// 10位编码配置文件
if is_videotoolbox {
    if let Some(depth) = settings.bit_depth {
        if depth >= 10 {
            cmd.arg("-profile:v").arg("main10");
        }
    }
}
```

## 前端UI控制

### 质量滑块组件

质量设置通过专门的滑块组件控制：

```vue
<!-- 来源：src/components/video-settings/QualitySettings.vue -->
<template>
  <div class="quality-slider-container">
    <!-- 质量等级显示 -->
    <span class="quality-text">{{ qualityText }}</span>
    
    <!-- 滑动条 -->
    <input 
      type="range" 
      min="2" 
      max="98" 
      v-model="qualityValue"
      @input="updateQualityState"
    />
    
    <!-- 位深度选择 -->
    <div class="bit-depth-buttons">
      <button @click="setBitDepth(8)">8bit</button>
      <button @click="setBitDepth(10)" :disabled="!canUse10bit">10bit</button>
      <button @click="setBitDepth(12)" :disabled="!canUse12bit">12bit</button>
    </div>
  </div>
</template>
```

### 实时参数显示

界面会实时显示当前的编码参数：

```typescript
const qualityText = computed(() => {
  const param = getEncoderQualityParam(
    props.currentVideoCodec || 'h264',
    props.isHardwareAccelerated || false,
    qualityValue.value
  );
  
  if (param.paramType === 'crf') {
    return `CRF: ${param.value}`;
  } else if (param.paramType === 'qv') {
    return `-q:v ${param.value}`; // VideoToolbox显示
  }
  
  return `${param.paramType}: ${param.value}`;
});
```

## 后端FFmpeg命令生成

### 完整的命令构建过程

```rust
// 1. 选择编码器
let ffmpeg_codec = "hevc_videotoolbox"; // 例如H.265

// 2. 设置像素格式
cmd.arg("-pix_fmt").arg("p010le"); // 10位

// 3. 设置配置文件
cmd.arg("-profile:v").arg("main10"); // 10位配置文件

// 4. 设置质量参数
match settings.quality_type.as_str() {
    "qv" => {
        let q = settings.qv_value.unwrap_or(80).min(100);
        cmd.arg("-q:v").arg(q.to_string());
    }
    "crf" => {
        if let Some(crf) = settings.crf_value {
            cmd.arg("-crf").arg(crf.to_string());
        }
    }
    // ... 其他质量类型
}

// 5. 设置分辨率滤镜（如果需要）
if !scale_filter.is_empty() {
    cmd.arg("-vf").arg(scale_filter);
}
```

### 示例FFmpeg命令

一个典型的ARM Mac H.265 10位编码命令：

```bash
ffmpeg -i input.mov \
  -c:v hevc_videotoolbox \
  -pix_fmt p010le \
  -profile:v main10 \
  -q:v 75 \
  -vf "scale=1920:1080,format=p010le" \
  output.mp4
```

## 质量与性能优化

### VideoToolbox 特有优势

1. **硬件加速**: 直接使用Apple Silicon的媒体引擎
2. **低功耗**: 相比软件编码显著降低CPU使用率
3. **实时编码**: 支持实时视频处理
4. **系统集成**: 与macOS媒体框架深度集成

### 质量参数建议

| 用途 | 推荐q:v值 | 说明 |
|------|-----------|------|
| 网络分享 | 55-65 | 平衡质量与文件大小 |
| 本地存储 | 70-80 | 高质量保存 |
| 专业用途 | 80-90 | 接近无损质量 |
| 快速预览 | 40-50 | 快速编码，较小文件 |

## 限制与注意事项

### VideoToolbox 限制

1. **12位支持**: hevc_videotoolbox不支持12位，会自动降级到10位
2. **编解码器支持**: 仅支持Apple Silicon原生支持的编解码器
3. **参数限制**: 某些高级FFmpeg参数可能不被支持

### 兼容性考虑

- **输出格式**: 建议使用MP4容器以获得最佳兼容性
- **播放设备**: 10位HEVC可能在某些旧设备上无法播放
- **文件大小**: 高质量设置会显著增加文件大小

## 总结

ARM Mac的显卡加速画质调节通过VideoToolbox框架实现，使用q:v参数而非传统的CRF值。前端提供直观的滑块控制，后端自动处理编码器选择、像素格式和质量参数的转换。这种设计既保证了编码性能，又提供了灵活的质量控制选项。

---

*文档生成时间: 2025-01-17 14:15:11*
*适用版本: ZipZap v0.8.26*