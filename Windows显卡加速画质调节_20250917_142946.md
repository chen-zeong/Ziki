# Windows显卡加速画质调节机制详解

## 概述

Windows平台支持三种主要的硬件编码器：NVIDIA NVENC、Intel Quick Sync Video (QSV) 和 AMD AMF。系统会自动检测可用的硬件编码器，并按照优先级顺序选择最佳的编码器。

## 硬件编码器检测与选择

### 检测优先级

Windows平台按以下优先级自动选择硬件编码器：

1. **AMD AMF** (最高优先级)
2. **Intel QSV** (中等优先级) 
3. **NVIDIA NVENC** (最低优先级)

```rust
// 来源：src-tauri/src/video/compression.rs
let candidates = vec![
    format!("{}_amf", base),    // AMD AMF
    format!("{}_qsv", base),    // Intel QSV
    format!("{}_nvenc", base),  // NVIDIA NVENC
];
for c in &candidates {
    if have(c) {
        selected = Some(c.clone());
        break;
    }
}
```

### 支持的编码器列表

| 厂商 | H.264编码器 | H.265编码器 | AV1编码器 |
|------|-------------|-------------|----------|
| NVIDIA | h264_nvenc | hevc_nvenc | av1_nvenc |
| Intel | h264_qsv | hevc_qsv | av1_qsv |
| AMD | h264_amf | hevc_amf | av1_amf |

### 核心显卡 vs 独立显卡

**默认显卡选择逻辑：**

- **有独立显卡时**：优先使用独立显卡的硬件编码器
  - AMD独立显卡 → 使用AMF编码器
  - NVIDIA独立显卡 → 使用NVENC编码器
  - Intel独立显卡 → 使用QSV编码器

- **仅有核心显卡时**：使用集成显卡的硬件编码器
  - Intel核心显卡 → 使用QSV编码器
  - AMD APU → 使用AMF编码器

- **混合配置**：系统会检测所有可用编码器，按优先级选择

## 画质控制机制

### 质量参数映射

Windows平台的硬件编码器使用不同的质量参数系统：

```typescript
// 来源：src/config/qualityMappings.ts
hardwareVendors: {
  // H.264编码器 - 统一使用q:v参数
  nvidia: { paramType: 'qv', values: [40, 55, 70, 75, 80], defaultIndex: 2 },
  intel:  { paramType: 'qv', values: [40, 55, 70, 75, 80], defaultIndex: 2 },
  amd:    { paramType: 'qv', values: [40, 55, 70, 75, 80], defaultIndex: 2 },
  
  // H.265编码器 - 使用CRF语义映射
  nvidia: { paramType: 'crf', values: [32, 28, 23, 20, 18], defaultIndex: 2 },
  intel:  { paramType: 'crf', values: [32, 28, 23, 20, 18], defaultIndex: 2 },
  amd:    { paramType: 'crf', values: [32, 28, 23, 20, 18], defaultIndex: 2 }
}
```

### 质量等级对照表

#### H.264编码器质量参数

| 质量等级 | NVENC(-q:v) | QSV(-q:v) | AMF(-q:v) | 描述 |
|---------|-------------|-----------|-----------|------|
| 极低 | 40 | 40 | 40 | 最小文件大小 |
| 低 | 55 | 55 | 55 | 较小文件大小 |
| 中等 | 70 | 70 | 70 | 平衡质量与大小 |
| 高 | 75 | 75 | 75 | 高质量 |
| 极高 | 80 | 80 | 80 | 最高质量 |

#### H.265编码器质量参数

| 质量等级 | NVENC(CRF) | QSV(CRF) | AMF(CRF) | 描述 |
|---------|------------|----------|----------|------|
| 极低 | 32 | 32 | 32 | 最小文件大小 |
| 低 | 28 | 28 | 28 | 较小文件大小 |
| 中等 | 23 | 23 | 23 | 平衡质量与大小 |
| 高 | 20 | 20 | 20 | 高质量 |
| 极高 | 18 | 18 | 18 | 最高质量 |

### 连续质量调节

用户可以通过滑块在质量等级之间进行连续调节：

```typescript
// 滑块值映射到实际参数
const getEncoderQualityParam = (
  codec: string,
  isHardwareAccelerated: boolean,
  sliderValue: number // 2-98
) => {
  // 检测编码器厂商
  const raw = codec.toLowerCase();
  let vendor = null;
  if (raw.includes('nvenc')) vendor = 'nvidia';
  else if (raw.includes('qsv')) vendor = 'intel';
  else if (raw.includes('amf')) vendor = 'amd';
  
  // 线性插值计算参数值
  const normalizedSlider = (sliderValue - 2) / 96;
  const interpolatedValue = minValue + (maxValue - minValue) * normalizedSlider;
  
  return { paramType, value: Math.round(interpolatedValue) };
};
```

## 后端FFmpeg命令生成

### 编码器选择流程

```rust
// 1. 检测平台
if cfg!(target_os = "windows") {
    // 2. 根据编解码器确定基础名称
    let base = match settings.codec.as_str() {
        "H.264" => "h264",
        "H.265" => "hevc", 
        "AV1" => "av1",
        _ => "",
    };
    
    // 3. 按优先级检测可用编码器
    let candidates = vec![
        format!("{}_amf", base),
        format!("{}_qsv", base), 
        format!("{}_nvenc", base),
    ];
    
    // 4. 选择第一个可用的编码器
    for c in &candidates {
        if hardware_support.has_encoder(c) {
            selected_encoder = c;
            break;
        }
    }
}
```

### 质量参数设置

```rust
// 根据质量类型设置参数
match settings.quality_type.as_str() {
    "crf" => {
        // NVENC: -cq 参数
        // QSV: -global_quality 参数  
        // AMF: -q:v 参数（近似CRF）
        if let Some(crf) = settings.crf_value {
            cmd.arg("-crf").arg(crf.to_string());
        }
    }
    "qv" => {
        // 统一使用 -q:v 参数
        let q = settings.qv_value.unwrap_or(70).min(100);
        cmd.arg("-q:v").arg(q.to_string());
    }
    "bitrate" => {
        // 固定比特率模式
        if let Some(bitrate) = &settings.bitrate {
            cmd.arg("-b:v").arg(bitrate);
        }
    }
}
```

### 示例FFmpeg命令

#### NVIDIA NVENC H.264编码
```bash
ffmpeg -i input.mp4 \
  -c:v h264_nvenc \
  -q:v 70 \
  -pix_fmt yuv420p \
  output.mp4
```

#### Intel QSV H.265编码
```bash
ffmpeg -i input.mp4 \
  -c:v hevc_qsv \
  -global_quality 23 \
  -pix_fmt nv12 \
  output.mp4
```

#### AMD AMF H.264编码
```bash
ffmpeg -i input.mp4 \
  -c:v h264_amf \
  -q:v 70 \
  -pix_fmt yuv420p \
  output.mp4
```

## 硬件编码器特性对比

### NVIDIA NVENC

**优势：**
- 编码速度极快
- 支持多路并行编码
- 低延迟编码
- 支持最新的AV1编码

**质量参数：**
- H.264: 使用 `-q:v` 参数 (0-51)
- H.265: 使用 `-cq` 参数 (0-51)
- 推荐范围: 18-32

### Intel Quick Sync Video (QSV)

**优势：**
- 功耗较低
- 与CPU集成度高
- 支持硬件解码加速
- 兼容性好

**质量参数：**
- H.264/H.265: 使用 `-global_quality` 参数 (1-51)
- 推荐范围: 18-28

### AMD AMF

**优势：**
- 功耗效率高
- 支持多种编码模式
- 与AMD GPU深度集成
- 质量与速度平衡好

**质量参数：**
- H.264/H.265: 使用 `-q:v` 参数 (0-51)
- 推荐范围: 20-30

## 位深度支持

### 像素格式选择

```rust
// Windows平台像素格式
let pix_fmt = match settings.bit_depth {
    Some(10) => "yuv420p10le",  // 10位
    Some(12) => "yuv420p12le",  // 12位
    _ => "yuv420p",             // 8位默认
};

// 特殊处理：QSV偏好nv12格式
if encoder.contains("qsv") {
    pix_fmt = match settings.bit_depth {
        Some(10) => "p010le",
        _ => "nv12",
    };
}
```

### 硬件编码器位深度支持

| 编码器 | 8位 | 10位 | 12位 | 备注 |
|--------|-----|------|------|------|
| NVENC | ✅ | ✅ | ❌ | 支持Main10 profile |
| QSV | ✅ | ✅ | ❌ | 需要较新的Intel GPU |
| AMF | ✅ | ✅ | ❌ | 支持HEVC Main10 |

## 性能优化建议

### 质量与速度平衡

| 用途 | 推荐编码器 | 质量设置 | 说明 |
|------|------------|----------|------|
| 实时录制 | NVENC | q:v 60-70 | 最快编码速度 |
| 直播推流 | QSV | CRF 25-28 | 低延迟优化 |
| 文件压缩 | AMF | CRF 20-23 | 质量与大小平衡 |
| 高质量存档 | 软件编码 | CRF 18-20 | 最佳质量 |

### 内存和显存使用

- **NVENC**: 占用显存较少，适合游戏录制
- **QSV**: 与系统内存共享，内存使用效率高
- **AMF**: 显存使用适中，支持动态调节

## 故障排除

### 常见问题

1. **编码器不可用**
   - 检查驱动程序版本
   - 确认硬件支持
   - 验证FFmpeg编译选项

2. **质量不理想**
   - 调整质量参数
   - 检查位深度设置
   - 考虑使用软件编码

3. **编码速度慢**
   - 降低质量设置
   - 减少分辨率
   - 检查硬件负载

### 兼容性检查

```rust
// 硬件编码器可用性检测
let encoders_to_test = vec![
    "h264_nvenc", "hevc_nvenc", "av1_nvenc",  // NVIDIA
    "h264_qsv", "hevc_qsv", "av1_qsv",        // Intel
    "h264_amf", "hevc_amf", "av1_amf",        // AMD
];

for encoder in encoders_to_test {
    let is_available = test_encoder_availability(encoder);
    println!("{}: {}", encoder, if is_available { "✅" } else { "❌" });
}
```

## 总结

Windows平台的显卡加速画质调节通过智能的硬件编码器检测和选择机制，为用户提供最佳的编码性能。系统优先选择AMD AMF，其次是Intel QSV，最后是NVIDIA NVENC。每种编码器都有其特定的质量参数系统，前端通过统一的滑块界面提供直观的质量控制，后端自动处理参数转换和FFmpeg命令生成。

**核心特点：**
- 自动检测和选择最佳硬件编码器
- 统一的质量控制界面
- 支持连续质量调节
- 优化的性能与质量平衡
- 完善的故障排除机制

---

*文档生成时间: 2025-01-17 14:29:46*
*适用版本: ZipZap v0.8.26*